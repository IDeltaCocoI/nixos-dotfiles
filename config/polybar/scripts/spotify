#!/usr/bin/env bash
# i3blocks - spotify
# Affiche titre + artiste + barre de progression et boutons
# Ne rien afficher si Spotify n'est pas en cours de lecture

if [ ! -z "$BLOCK_BUTTON" ]; then
    # Focus ou lance Spotify sans afficher le retour
    i3-msg "[class=\"Spotify\"] focus" &>/dev/null || i3-msg exec spotify &>/dev/null
fi

# Vérifier si Spotify est actif
playerctl --player=spotify status &>/dev/null || exit 0

STATUS=$(playerctl --player=spotify status)
ARTIST=$(playerctl --player=spotify metadata artist 2>/dev/null)
TITLE=$(playerctl --player=spotify metadata title 2>/dev/null | sed 's/ *(.*)//')

# Durée et position en microsecondes / secondes
DURATION_US=$(playerctl --player=spotify metadata mpris:length 2>/dev/null)
POSITION_S=$(playerctl --player=spotify position 2>/dev/null)

# Convertir durée en secondes flottantes
DURATION_S=$(awk -v d="$DURATION_US" 'BEGIN {printf "%.2f", d/1000000}')

# Barre de progression
BAR_LENGTH=5
PROGRESS=$(awk -v pos="$POSITION_S" -v dur="$DURATION_S" -v len="$BAR_LENGTH" 'BEGIN {
    filled=int(pos/dur*len)
    empty=len-filled
    if(filled>len) filled=len
    bar=""
    for(i=0;i<filled;i++) bar=bar "■"
    for(i=0;i<empty;i++) bar=bar "□"
    print bar
}')

# Affichage
echo "    $ARTIST - $TITLE $PROGRESS "

